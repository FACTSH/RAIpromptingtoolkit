<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Prompt Studio</title>
  
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />

  <style>
    :root {
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.98);
      --card-border: rgba(148, 163, 184, 0.4);
      --card-border-soft: rgba(148, 163, 184, 0.15);
      --text-primary: #e5e7eb;
      --text-muted: #9ca3af;
      --accent-primary: #6366f1;
      --accent-secondary: #22c55e;
      --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --radius-lg: 20px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --transition-fast: 0.18s ease-out;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px 20px 40px;
      font-family: var(--font-main);
      color: var(--text-primary);
      background:
        radial-gradient(circle at top, #1d2748 0, transparent 55%),
        radial-gradient(circle at bottom left, #0f766e 0, transparent 50%),
        var(--bg);
      min-height: 100vh;
    }

    /* Header */
    header {
      max-width: 1280px;
      margin: 0 auto 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
    }

    .header-content {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    #app-logo {
      height: 100px; 
      width: 100px; 
      border-radius: 24px; 
      background: #1e293b;
      object-fit: cover;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .header-text h1 {
      margin: 0 0 8px 0;
      font-size: 2.2rem;
      font-weight: 700;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-text p {
      margin: 0 0 16px 0;
      font-size: 1rem;
      color: var(--text-muted);
      line-height: 1.5;
      max-width: 700px;
    }

    /* Significance Box in Header */
    .significance-box {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-left: 4px solid var(--accent-primary);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #cbd5e1;
      max-width: 800px;
    }
    .significance-box strong { color: #818cf8; }

    /* Grid Layout */
    .bento-grid {
      max-width: 1280px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 20px;
    }

    .bento-item {
      background: radial-gradient(circle at top left, #111827 0, #020617 70%);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--card-border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      transition: transform var(--transition-fast), border-color var(--transition-fast);
    }

    .bento-item:hover {
      border-color: var(--card-border);
      transform: translateY(-2px);
    }

    /* Specific Grid Areas */
    .bento-prompt { grid-column: 1; grid-row: 1 / span 2; }
    .bento-output { grid-column: 2; grid-row: 1; }
    .bento-analysis { grid-column: 2; grid-row: 2; }
    .bento-ablation { grid-column: 1; grid-row: 3; }
    .bento-counterfactual { grid-column: 2; grid-row: 3; }
    .bento-preview { grid-column: 1 / span 2; grid-row: 4; display: none; }

    /* Typography */
    h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      text-transform: uppercase;
      color: #c7d2fe;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h3 span.step {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(79, 70, 229, 0.2);
      border: 1px solid rgba(129, 140, 248, 0.4);
      font-size: 0.75rem;
      color: #e5e7eb;
    }

    /* Educational Context Blocks */
    .edu-context {
      background: rgba(15, 23, 42, 0.6);
      border: 1px dashed rgba(71, 85, 105, 0.6);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    
    .edu-context summary {
      font-size: 0.85rem;
      font-weight: 600;
      color: #94a3b8;
      cursor: pointer;
      list-style: none;
    }
    
    .edu-context summary:hover { color: #e2e8f0; }
    .edu-context summary::after { content: " +"; font-weight: bold; }
    .edu-context[open] summary::after { content: " -"; }

    .edu-content {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #cbd5e1;
      line-height: 1.5;
    }
    .edu-content b { color: #818cf8; }

    /* Inputs & Buttons */
    textarea, input[type="text"] {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: #0f172a;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      outline: none;
    }
    
    textarea:focus, input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      color: white;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
    }

    button:disabled {
      background: #334155 !important;
      color: #94a3b8;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    #b-generate { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    #b-analyze { background: linear-gradient(135deg, #22c55e, #16a34a); }
    #b-ablate { background: linear-gradient(135deg, #f97316, #ea580c); }
    #b-counterfactual { background: linear-gradient(135deg, #06b6d4, #0891b2); }

    button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }

    /* Visualization Styles */
    .status-line { font-size: 0.8rem; color: #94a3b8; min-height: 1.2em; margin-top: 4px; }
    
    .impact-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 2px;
      font-size: 0.85rem;
    }
    .impact-5 { background: rgba(220, 38, 38, 0.9); color: white; } /* High */
    .impact-4 { background: rgba(248, 113, 113, 0.7); color: white; }
    .impact-3 { background: rgba(234, 179, 8, 0.5); color: white; }
    .impact-1 { background: rgba(34, 197, 94, 0.2); color: #bbf7d0; } /* Low */
    
    /* Comparison Boxes for Results */
    .compare-container { display: flex; gap: 20px; margin-top: 10px; }
    .compare-box { flex: 1; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; }
    .compare-box strong { display: block; font-size: 0.85rem; color: #94a3b8; margin-bottom: 6px; }
    .compare-box pre { white-space: pre-wrap; font-size: 0.85rem; margin: 0; color: #e2e8f0; font-family: var(--font-mono); }

    /* Responsive */
    @media (max-width: 1024px) {
      .bento-grid { grid-template-columns: 1fr; }
      .bento-prompt, .bento-output, .bento-analysis, .bento-ablation, .bento-counterfactual {
        grid-column: 1; grid-row: auto;
      }
      .compare-container { flex-direction: column; }
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <img src="factsh.jpeg" alt="AI Tool Logo" id="app-logo" />
      <div class="header-text">
        <h1>Smart Prompt Studio</h1>
        <p>A simple workspace to "tune" your AI instructions. Just like tuning a radio, we help you find the clearest signal so the AI does exactly what you want, without guessing.</p>
        
        <div class="significance-box">
          <strong>Why this matters:</strong> AI can sometimes act like a black box. This tool opens it up. We help you <strong>Spotlight</strong> what matters (Heatmaps), <strong>Erase</strong> clutter (Eraser Test), and <strong>Swap</strong> ideas (Scenario Test) to make sure your instruction is bulletproof.
        </div>
      </div>
    </div>
  </header>

  <div class="bento-grid">
    
    <div class="bento-item bento-prompt">
      <h3><span class="step">1</span>Your Instruction</h3>
      
      <details class="edu-context" open>
        <summary>What is this?</summary>
        <div class="edu-content">
          <br>
          <b>The Recipe:</b> This is the command you give the AI. <br>
          <b>Why:</b> Vague instructions are like a bad recipe—the result will be messy. We need to be precise.<br>
        </div>
      </details>

      <textarea id="prompt-input" placeholder="e.g., Write a short, formal, and polite email to my manager about a sick day.">Write a short, formal, and polite email to my manager about a sick day.</textarea>
      <button id="b-generate">Get Answer</button>
      <div id="status-generate" class="status-line"></div>
    </div>

    <div class="bento-item bento-output">
      <h3><span class="step">2</span>The AI's Answer</h3>
      
      <details class="edu-context">
        <summary>What is this?</summary>
        <div class="edu-content">
          

[Image of a robot printing a document]
<br>
          <b>The Draft:</b> This is what the AI wrote based on your recipe.<br>
          <b>Why:</b> We need this first draft to check if the AI actually listened to you (e.g., was it actually "polite"?).
        </div>
      </details>

      <textarea id="output-display" readonly placeholder="Answer appears here..."></textarea>
      <button id="b-analyze" disabled>Analyze This</button>
      <div id="status-analyze" class="status-line"></div>
    </div>

    <div class="bento-item bento-analysis">
      <h3><span class="step">3</span>Spotlight Check</h3>
      
      <details class="edu-context" open>
        <summary>How does this work?</summary>
        <div class="edu-content">
          

[Image of a heatmap visualization of text]
<br>
          <b>The Thermal Camera:</b> We highlight words in Red (Hot) or Green (Cold).<br>
          <b>Why:</b> Red words are what the AI focused on. If your most important instruction is Green, the AI ignored it!
        </div>
      </details>

      <div id="analysis-report-display" style="margin-top:10px; font-size:0.9rem; color:#cbd5e1;">
        <i>Complete Step 2 to unlock the spotlight.</i>
      </div>
    </div>

    <div class="bento-item bento-ablation">
      <h3><span class="step">A</span>The "Eraser" Test</h3>
      
      <details class="edu-context">
        <summary>Why use this?</summary>
        <div class="edu-content">
          <br>
          <b>Less is More:</b> We delete a word (like "polite") and ask the AI again.<br>
          <b>Why:</b> If deleting the word changes nothing, then that word was useless. Keep your instructions clean!
        </div>
      </details>

      <input type="text" id="ablation-input" placeholder="Words to erase (auto-filled after analysis)" />
      <button id="b-ablate" disabled>Run Test</button> <div id="status-ablation" class="status-line"></div>
    </div>

    <div class="bento-item bento-counterfactual">
      <h3><span class="step">B</span>The "Swap" Test</h3>
      
      <details class="edu-context">
        <summary>Why use this?</summary>
        <div class="edu-content">
          <br>
          <b>The Flip:</b> We swap a word for its opposite (e.g., "formal" → "casual").<br>
          <b>Why:</b> To check understanding. If you ask for "rude" instead of "polite", does the AI actually change its tone?
        </div>
      </details>

      <textarea id="counterfactual-input" style="min-height: 60px;" placeholder="formal, informal&#10;polite, rude"></textarea>
      <button id="b-counterfactual" disabled>Run Test</button> <div id="status-counterfactual" class="status-line"></div>
    </div>

    <div class="bento-item bento-preview" id="experiment-display"></div>
  </div>


  <script>
    const promptInput = document.getElementById("prompt-input");
    const outputDisplay = document.getElementById("output-display");
    const ablationInput = document.getElementById("ablation-input");
    const counterfactualInput = document.getElementById("counterfactual-input");

    const bGenerate = document.getElementById("b-generate");
    const bAnalyze = document.getElementById("b-analyze");
    const bAblate = document.getElementById("b-ablate");
    const bCounterfactual = document.getElementById("b-counterfactual");

    const statusGenerate = document.getElementById("status-generate");
    const statusAnalyze = document.getElementById("status-analyze");
    const statusAblation = document.getElementById("status-ablation");
    const statusCounterfactual = document.getElementById("status-counterfactual");

    const analysisDisplay = document.getElementById("analysis-report-display");
    const experimentDisplay = document.getElementById("experiment-display");

    const appState = {
      original_prompt: "",
      original_output: "",
      original_analysis: {}
    };

    function buildHeatmapHTML(heatmapData) {
      if (!Array.isArray(heatmapData) || heatmapData.length === 0) {
        return "<p><i>No heatmap data available.</i></p>";
      }
      let html = "<div style='line-height: 1.9;'>";
      heatmapData.forEach(item => {
        const word = item.word || "";
        const score = item.impact_score || 0;
        const clamped = Math.max(1, Math.min(5, score));
        html += `<span class="impact-${clamped}">${word}</span>`;
      });
      html += "</div>";
      return html;
    }

    function buildReportHTML(connectionsData) {
      if (!Array.isArray(connectionsData) || connectionsData.length === 0) {
        return "<p><i>No key connections identified.</i></p>";
      }
      let html = "";
      connectionsData.forEach(item => {
        const promptWord = item.prompt_word || "N/A";
        const score = item.impact_score || 0;
        const outputWords = item.influenced_output_words || [];
        const promptClass = score >= 4 ? "prompt-word-high" : "prompt-word-med";

        html += `<div class="report-item">`;
        html += `<span class="${promptClass}">${promptWord}</span>`;
        html += `<span class="arrow">→</span>`;
        if (outputWords.length === 0) {
          html += "<i>(No direct output words identified)</i>";
        } else {
          html += outputWords
            .map(w => `<span class="output-word">${w}</span>`)
            .join(" ");
        }
        html += "</div>";
      });
      return html;
    }

    function buildScoreHTML(scoreData) {
      const rawScore =
        scoreData && typeof scoreData.semantic_change_score === "number"
          ? scoreData.semantic_change_score
          : 0;
      const score = Math.max(1, Math.min(10, rawScore || 1));
      const summary =
        (scoreData && scoreData.change_summary) || "No summary available.";

      const red = Math.floor((score - 1) * (255 / 9));
      const green = 255 - red;
      const color = `rgb(${red}, ${green}, 0)`;

      return `
        <div class="change-report">
          <strong>Impact Score (semantic_change_score)</strong>
          <div class="score-bar-container">
            <div class="score-bar-fill" style="width: ${score * 10}%; background-color: ${color};">
              ${score} / 10
            </div>
          </div>
          <div class="change-summary"><strong>Summary:</strong> ${summary}</div>
        </div>
      `;
    }

    function setStatus(el, message, isError = false) {
      if (!el) return;
      el.textContent = message;
      el.style.color = isError ? "#f97373" : "var(--text-muted)";
    }

    function clearAllStatuses() {
      [statusGenerate, statusAnalyze, statusAblation, statusCounterfactual].forEach(el => {
        if (el) el.textContent = "";
      });
    }

    function setLoading(isLoading) {
      [bGenerate, bAnalyze, bAblate, bCounterfactual].forEach(btn => {
        btn.disabled = isLoading || (btn === bAnalyze && !outputDisplay.value);
      });
    }

    bGenerate.addEventListener("click", async () => {
      clearAllStatuses();
      setLoading(true);

      appState.original_prompt = promptInput.value.trim();
      experimentDisplay.innerHTML = "";
      experimentDisplay.style.display = "none";
      analysisDisplay.innerHTML =
        "Click <b>Analyze Significance</b> to see the heatmap and key connections.";

      if (!appState.original_prompt) {
        setLoading(false);
        setStatus(statusGenerate, "Please enter a prompt first.", true);
        return;
      }
      
      // Check word count (proxy for tokens)
      if (appState.original_prompt.split(/\s+/).length > 20) {
        setLoading(false);
        setStatus(statusGenerate, "Error: Keep the prompt less than 20.", true);
        return;
      }

      setStatus(statusGenerate, "Generating output...");

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: appState.original_prompt })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || `Server error ${res.status}`);
        }

        const data = await res.json();
        if (data.error) throw new Error(data.error);

        appState.original_output = data.output || "";
        outputDisplay.value = appState.original_output;
        appState.original_analysis = {};
        bAnalyze.disabled = !appState.original_output;
        setStatus(statusGenerate, "Output generated.");
      } catch (err) {
        console.error("Generate error:", err);
        setStatus(statusGenerate, `${err.message}`, true);
      } finally {
        setLoading(false);
      }
    });

    bAnalyze.addEventListener("click", async () => {
      clearAllStatuses();

      if (!appState.original_prompt || !appState.original_output) {
        setStatus(statusAnalyze, "Generate an output first.", true);
        return;
      }

      setLoading(true);
      setStatus(statusAnalyze, "Analyzing prompt–output relationship...");

      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: appState.original_prompt,
            output: appState.original_output
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Server error ${res.status}: ${text}`);
        }

        const data = await res.json();
        appState.original_analysis = data;

        if (data.error) {
          analysisDisplay.innerHTML =
            `<p style="color: #f97373; font-weight: 600;">Analysis failed:</p><pre>${data.error}</pre>`;
          setStatus(statusAnalyze, "Analysis failed.", true);
          return;
        }

        const heatmapHTML = buildHeatmapHTML(data.heatmap_data);
        const reportHTML = buildReportHTML(data.connections);

        analysisDisplay.innerHTML = `
          <h4>Prompt Heatmap</h4>
          <details style="margin-bottom: 8px; font-size: 0.8rem;">
            <summary><strong>How are heatmap scores (1–5) computed?</strong></summary>
            <div style="margin-top: 4px;">
              <p>An auxiliary model estimates how much each token affects the generated output. 1 = low impact, 5 = very high impact.</p>
            </div>
          </details>
          ${heatmapHTML}
          <h4 style="margin-top: 14px;">Significance Report</h4>
          ${reportHTML}
        `;

        if (Array.isArray(data.heatmap_data)) {
          const highImpactWords = data.heatmap_data
            .filter(item => (item.impact_score || 0) >= 4 && item.word && /^[a-zA-Z0-9]+$/.test(item.word))
            .map(item => item.word);
          ablationInput.value = [...new Set(highImpactWords)].join(", ");
        }

        setStatus(statusAnalyze, "Analysis complete.");
      } catch (err) {
        console.error("Analyze error:", err);
        setStatus(statusAnalyze, `Error: ${err.message}`, true);
      } finally {
        setLoading(false);
      }
    });

    async function runExperiment(type) {
      const statusEl = type === "ablation" ? statusAblation : statusCounterfactual;
      clearAllStatuses();

      if (
        !appState.original_prompt ||
        !appState.original_output ||
        !appState.original_analysis.heatmap_data
      ) {
        setStatus(
          statusEl,
          "Run <b>Generate Output</b> and <b>Analyze Significance</b> before experiments.",
          true
        );
        return;
      }

      setLoading(true);
      setStatus(statusEl, `Running ${type} study...`);
      experimentDisplay.innerHTML = "";
      experimentDisplay.style.display = "none";

      let changes;
      try {
        if (type === "ablation") {
          changes = ablationInput.value;
          if (!changes.trim()) {
            throw new Error("Enter at least one word to remove, e.g., formal, polite");
          }
        } else {
          changes = counterfactualInput.value;
          if (!changes.trim()) {
            throw new Error("Enter at least one line like: formal, informal");
          }
        }
      } catch (err) {
        setLoading(false);
        setStatus(statusEl, err.message, true);
        return;
      }

      try {
        const res = await fetch("/api/run_experiment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type,
            original_prompt: appState.original_prompt,
            original_output: appState.original_output,
            changes
          })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || `Server error ${res.status}`);
        }

        const data = await res.json();
        if (data.error) throw new Error(data.error);

        experimentDisplay.style.display = "block";

        const originalHeatmap = buildHeatmapHTML(appState.original_analysis.heatmap_data);
        const originalReport = buildReportHTML(appState.original_analysis.connections);

        const beforeHTML = `
          <h3>Before</h3>
          <b>Prompt</b>
          <pre>${appState.original_prompt}</pre>
          <b>Heatmap</b>
          ${originalHeatmap}
          <b>Significance</b>
          ${originalReport}
        `;

        const newHeatmap = buildHeatmapHTML(data.new_analysis.heatmap_data);
        const newReport = buildReportHTML(data.new_analysis.connections);

        const afterHTML = `
          <h3>After</h3>
          <b>Prompt</b>
          <pre>${data.new_prompt}</pre>
          <b>Heatmap</b>
          ${newHeatmap}
          <b>Significance</b>
          ${newReport}
        `;

        const scoreHTML = buildScoreHTML(data.change_data);

        experimentDisplay.innerHTML = `
          <h2 style="margin: 0 0 8px; font-size: 1.1rem;">${type.charAt(0).toUpperCase() + type.slice(1)} Study Results</h2>
          <div class="compare-container">
            <div class="compare-box compare-before">${beforeHTML}</div>
            <div class="compare-box">${afterHTML}</div>
          </div>
          <hr style="margin-top: 14px; border-color: rgba(55, 65, 81, 0.8);" />
          <h3 style="margin-top: 10px;">Change Analysis</h3>
          <details style="margin-bottom: 8px; font-size: 0.8rem;">
            <summary><strong>How is the semantic change score (1–10) computed?</strong></summary>
            <div style="margin-top: 4px;">
              <p>An evaluator model compares original and new outputs, scoring how much the meaning, tone, or structure changed (1 = minimal, 10 = major shift).</p>
            </div>
          </details>
          ${scoreHTML}
          <hr style="margin-top: 16px; border-color: rgba(55, 65, 81, 0.8);" />
          <h3 style="margin-top: 10px;">Original Output</h3>
          <pre>${appState.original_output}</pre>
          <h3>New Output</h3>
          <pre>${data.new_output}</pre>
        `;

        setStatus(statusEl, `${type.charAt(0).toUpperCase() + type.slice(1)} study complete.`);
      } catch (err) {
        console.error("Experiment error:", err);
        setStatus(statusEl, `Error: ${err.message}`, true);
        experimentDisplay.innerHTML =
          `<p style="color: #f97373;"><strong>Error:</strong> ${err.message}</p>`;
        experimentDisplay.style.display = "block";
      } finally {
        setLoading(false);
      }
    }

    bAblate.addEventListener("click", () => runExperiment("ablation"));
    bCounterfactual.addEventListener("click", () => runExperiment("counterfactual"));
  </script>
</body>
</html>